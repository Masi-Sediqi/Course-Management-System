{% extends 'base.html' %}
{% block content %}
{% load static %}

<!-- Move all CSS links to the head section properly -->
<link href="{% static 'css/sweet.css' %}" rel="stylesheet">
<!-- Use CDN for Bootstrap Icons instead of static -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="{% static 'js/sweet.js' %}"></script>

<style>
    /* Improvement Process Steps */
    .process-step {
        position: relative;
        min-width: 180px;
    }
    
    .step-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        font-size: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .arrow-container {
        display: flex;
        align-items: center;
    }
    
    .step-form select, .step-form input {
        width: 100%;
        text-align: center;
        font-weight: 500;
        border-radius: 8px;
        padding: 8px 12px;
        border: 1px solid #dee2e6;
    }
    
    /* File Upload Area */
    .file-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .file-upload-area:hover {
        border-color: #667eea;
        background-color: rgba(102, 126, 234, 0.05);
    }
    
    .upload-box {
        color: #6c757d;
    }
    
    /* Form Input Styling */
    .form-control, .form-select {
        border-radius: 8px;
        padding: 12px 15px;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .input-group-text {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
    
    /* Responsive Design */
    @media (max-width: 992px) {
        .improvement-process .d-flex {
            flex-direction: column;
        }
        
        .arrow-container {
            transform: rotate(90deg);
            margin: 1rem 0;
        }
        
        .process-step {
            margin-bottom: 2rem;
        }
    }
    
    /* Sticky footer */
    .sticky-bottom {
        position: sticky;
        bottom: 0;
        z-index: 1020;
    }
    
    /* Datepicker styling */
    #datepicker21 {
        cursor: pointer;
    }
</style>

<div class="main-content pt-4" style="font-family: 'Vazirmatn', sans-serif;">
    <div class="breadcrumb">
        <h1>ویرایش ارتقاع شاگرد</h1>
        <ul>
            <li><a href="/">داشبورد</a></li>
            <li><a href="{% url 'students:student_detail' student_improvement.student.id %}">{{ student_improvement.student.first_name }} {{ student_improvement.student.last_name }}</a></li>
            <li>ویرایش ارتقاع</li>
        </ul>
    </div>
    
    <div class="separator-breadcrumb border-top"></div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pencil-square me-2"></i>
                        ویرایش ارتقاع: {{ student_improvement.student.first_name }} {{ student_improvement.student.last_name }}
                    </h5>
                </div>
                <div class="card-body">
                    <form class="needs-validation" novalidate
                        action="{% url 'students:edit_student_improvement' id=student_improvement.id %}"
                        method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- Header Section -->
                        <div class="text-center mb-5">
                            <div class="improvement-process mb-4">
                                <div class="d-flex justify-content-center align-items-center flex-wrap">
                                    <!-- Past Class -->
                                    <div class="process-step text-center">
                                        <div class="step-circle bg-info">
                                            <i class="bi bi-book text-white"></i>
                                        </div>
                                        <h6 class="mt-2">صنف قبلی</h6>
                                        <div class="step-form">
                                            <select name="past_class" class="form-select" required>
                                                {% for fee in paid_fess_classes %}
                                                <option value="{{ fee.st_class.id }}" 
                                                    {% if fee.st_class.id == student_improvement.past_class.id %}selected{% endif %}>
                                                    {{ fee.st_class.name }}
                                                </option>
                                                {% empty %}
                                                <option disabled>هیچ صنفی پیدا نشد</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Arrow -->
                                    <div class="arrow-container mx-4">
                                        <i class="bi bi-arrow-left-circle-fill text-primary" style="font-size: 2.5rem;"></i>
                                    </div>

                                    <!-- Middle Class (Optional) -->
                                    <div class="process-step text-center">
                                        <div class="step-circle bg-warning">
                                            <i class="bi bi-arrow-left-right text-white"></i>
                                        </div>
                                        <h6 class="mt-2">تکمیل دوره</h6>
                                        <div class="step-form">
                                            <input type="text" name="middle_class" 
                                                class="form-control text-center"
                                                placeholder="دوره تکمیل شده" 
                                                value="{{ student_improvement.middle_class|default:'' }}"
                                                style="min-width: 150px;">
                                        </div>
                                    </div>

                                    <!-- Arrow -->
                                    <div class="arrow-container mx-4">
                                        <i class="bi bi-arrow-left-circle-fill text-primary" style="font-size: 2.5rem;"></i>
                                    </div>

                                    <!-- New Class -->
                                    <div class="process-step text-center">
                                        <div class="step-circle bg-success">
                                            <i class="bi bi-book-half text-white"></i>
                                        </div>
                                        <h6 class="mt-2">صنف جدید</h6>
                                        <div class="step-form">
                                            {{ form.after_class }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Fields -->
                        <div class="row">
                            <!-- Date Field -->
                            <div class="col-md-6">
                                <div class="form-group mb-4">
                                    <label class="form-label">
                                        <i class="bi bi-calendar-date me-2"></i>
                                        تاریخ ارتقاع <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="bi bi-calendar"></i>
                                        </span>
                                        <input type="text" name="date" id="datepicker21" 
                                               class="form-control" 
                                               value="{{ student_improvement.date|date:'Y/m/d' }}"
                                               required>
                                    </div>
                                    <small class="form-text text-muted">تاریخ تکمیل دوره قبلی را وارد کنید</small>
                                </div>
                            </div>

                            <!-- Score Field -->
                            <div class="col-md-6">
                                <div class="form-group mb-4">
                                    <label class="form-label">
                                        <i class="bi bi-award me-2"></i>
                                        نمره اخذ شده <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="bi bi-percent"></i>
                                        </span>
                                        <input type="number" name="number" class="form-control" 
                                               value="{{ student_improvement.number }}"
                                               min="0" max="100" step="0.01" required>
                                        <span class="input-group-text">از ۱۰۰</span>
                                    </div>
                                    <div class="progress mt-2" style="height: 8px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                            style="width: {{ student_improvement.number }}%;" 
                                            aria-valuenow="{{ student_improvement.number }}" 
                                            aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Current File Display -->
                            {% if student_improvement.file %}
                            <div class="col-12 mb-3">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    فایل فعلی: 
                                    <a href="{{ student_improvement.file.url }}" target="_blank" class="alert-link">
                                        <i class="bi bi-file-earmark-text me-1"></i>
                                        مشاهده فایل
                                    </a>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Upload File -->
                            <div class="col-12">
                                <div class="form-group mb-4">
                                    <label class="form-label">
                                        <i class="bi bi-file-earmark-text me-2"></i>
                                        تقدیر نامه / گواهینامه
                                    </label>
                                    <div class="file-upload-area">
                                        <div class="upload-box"
                                            onclick="document.getElementById('id_file').click()">
                                            <i class="bi bi-cloud-upload" style="font-size: 3rem;"></i>
                                            <p class="mt-2" id="fileName">
                                                {% if student_improvement.file %}
                                                    {{ student_improvement.file.name|cut:"improvements/" }}
                                                {% else %}
                                                    فایل را اینجا رها کنید یا کلیک کنید
                                                {% endif %}
                                            </p>
                                            <small class="text-muted">فرمت‌های مجاز: PDF, JPG, PNG (حداکثر 5MB)</small>
                                        </div>
                                        <input type="file" name="file" id="id_file" class="d-none" accept=".pdf,.jpg,.jpeg,.png">
                                    </div>
                                    {% if student_improvement.file %}
                                    <div class="form-check mt-2">
                                        <input type="checkbox" name="file-clear" id="file-clear" class="form-check-input">
                                        <label for="file-clear" class="form-check-label text-danger">
                                            <i class="bi bi-trash me-1"></i>
                                            حذف فایل فعلی
                                        </label>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Description Field -->
                            <div class="col-12">
                                <div class="form-group mb-4">
                                    <label class="form-label">
                                        <i class="bi bi-chat-left-text me-2"></i>
                                        توضیحات تکمیلی
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="bi bi-pencil"></i>
                                        </span>
                                        <textarea name="description" class="form-control" rows="4" 
                                                  placeholder="توضیحات مربوط به ارتقاع...">{{ student_improvement.description|default:'' }}</textarea>
                                    </div>
                                    <small class="form-text text-muted">هرگونه توضیح اضافی درباره ارتقاع، عملکرد شاگرد یا توصیه‌های خاص</small>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between align-items-center border-top pt-4 mt-4">
                            <a href="{% url 'students:student_detail' student_improvement.student.id %}" 
                               class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-right me-1"></i>
                                بازگشت
                            </a>
                            <div>
                                <button type="reset" class="btn btn-outline-warning me-2">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>
                                    بازنشانی
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle me-1"></i>
                                    ذخیره تغییرات
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize datepicker
    if ($('#datepicker21').length) {
        $('#datepicker21').datepicker({
            format: 'yyyy/mm/dd',
            autoclose: true,
            todayHighlight: true
        });
    }
    
    // File upload preview
    const fileInput = document.getElementById('id_file');
    const fileNameDisplay = document.getElementById('fileName');
    
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || 'هیچ فایلی انتخاب نشده';
            fileNameDisplay.textContent = fileName;
        });
    }
    
    // Drag and drop for file upload
    const uploadArea = document.querySelector('.file-upload-area');
    
    if (uploadArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            uploadArea.style.borderColor = '#667eea';
            uploadArea.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
        }
        
        function unhighlight() {
            uploadArea.style.borderColor = '#dee2e6';
            uploadArea.style.backgroundColor = 'transparent';
        }
        
        uploadArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileNameDisplay.textContent = files[0]?.name || 'فایل آپلود شد';
            }
        }
    }
    
    // Progress bar update based on score input
    const scoreInput = document.querySelector('input[name="number"]');
    const progressBar = document.querySelector('.progress-bar');
    
    if (scoreInput && progressBar) {
        scoreInput.addEventListener('input', function() {
            let value = parseInt(this.value) || 0;
            value = Math.min(100, Math.max(0, value));
            progressBar.style.width = value + '%';
            progressBar.setAttribute('aria-valuenow', value);
        });
    }
});
</script>

{% endblock %}