{% extends 'base.html' %}
{% load static %}

{% block content %}

<link href="{% static 'css/sweet.css' %}" rel="stylesheet">
<script src="{% static 'js/sweet.js' %}"></script>

    <script>
        {% if messages %}
            {% for message in messages %}
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}",
                    title: "{{ message|escapejs }}",
                    showConfirmButton: false,
                    timer: 4000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });
            {% endfor %}
        {% endif %}
    </script>

<div class="container-xxl flex-grow-1 container-p-y" style="font-family: 'Vazirmatn', sans-serif;">
    <h4 class="py-3 mb-4">
        <span class="text-muted fw-light">داشبورد /</span> بخش گزارشات شاگردان 
    </h4>


    <div class="row">
        <div class="col-lg-12 col-md-6 col-sm-6">
            <div class="card card-icon-bg card-icon-bg-primary o-hidden mb-4">
                <div class="card-body text-center">  
                    <div class="card-title mb-3">
                        <button id="pwa-install-btn" class="btn btn-primary" data-toggle="modal" data-target="#filterModal">
                            فلتر
                        </button>
                    </div>
                    {% if filter_active == True %}
                    <div class="card-title mb-3">
                        <a href="{% url 'reports:students_reports' %}" id="pwa-install-btn" class="btn btn-danger">
                            حذف فلتر
                        </a>
                    </div>
                    {% endif %}
                    
                    <!-- Typing text -->
                    <div class="typing-text">
                        <span class="badge badge-pill badge-warning fs-4">  {{title}}</span>
                       
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CSS -->
    <style>
    .typing-text {
        font-family: 'XW_Zar_Bd_0', sans-serif;
        font-size: 16px;
        color: #000000;
        border-right: 2px solid #fff;
        white-space: nowrap;
        overflow: hidden;
        width: 0;
        animation: typing 3s steps(40, end) forwards, blink 0.75s step-end infinite;
        margin: 10px auto 0;
    }
    
    /* Typing animation */
    @keyframes typing {
        from { width: 0 }
        to { width: 100% }
    }
    
    /* Blinking cursor */
    @keyframes blink {
        0%, 100% { border-color: transparent }
        50% { border-color: #fff }
    }
    </style>
    


    <div class="card">
        <div class="card-body">

                <!-- Tab 1: Income Table -->
                <div class="tab-pane fade show active" id="income" role="tabpanel">
                    <!-- ✅ Paste your full income table & modals here -->
    
                <div class="table-responsive">
    <table class="display table table-striped table-bordered" id="comma_decimal_table" style="width:100%">
        <thead class="thead-dark">
            <tr>
                <th>#</th>
                <th>نام و تخلص</th>
                <th>نام پدر</th>

                {% if filter_type == "students_complete_fess" %}
                    <th>تاریخ پرداخت فیس</th>
                    <th>تاریخ ختم فیس</th>
                {% else %}
                    <th>تاریخ ثبت نام</th>
                    <th>شماره موبایل</th>
                {% endif %}

                <th>جنسیت</th>

                {% if filter_type == "students_withoutclass" %}
                    <th>تاریخ برای هشدار</th>
                {% endif %}

                {% if filter_type == "loan_students" %}
                    <th>مقدار باقی مانده</th>
                {% endif %}
            </tr>
        </thead>

        <tbody id="table-body">
            {% for i in students %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td><a href="{% url 'students:student_detail' i.id %}">
                      {% if filter_type == "students_complete_fess" %}
                    {{ i.student.first_name }} {{ i.student.last_name }}</a></td>
                <td>{{ i.student.father_name }}</td>
                {% else %}
                 {{ i.first_name }} {{ i.last_name }}</a></td>
                <td>{{ i.father_name }}</td>
                {% endif %}

                {% if filter_type == "students_complete_fess" %}
                    <td>{{ i.date }}</td>
                    <td>{{ i.end_date }}</td>
                {% else %}
                    <td>{{ i.date_of_registration }}</td>
                    <td>{{ i.phone }}</td>
                {% endif %}

                <td>
                    {% if i.student.gender == 'Male' %}مرد{% else %}زن{% endif %}
                </td>

                {% if filter_type == "students_withoutclass" %}
                    <td>{{ i.date_for_notification }}</td>
                {% endif %}

                {% if filter_type == "loan_students" %}
                    <td>
                        {% with i.student_remains.first.amount as remain %}
                            {{ remain }}
                        {% endwith %}
                    </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

                </div>
 
        </div>
    </div>
    

    <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
    
                <!-- Modal Header -->
                <div class="modal-header bg-gradient-primary text-white border-0">
                    <h5 class="modal-title" id="filterModalLabel"><i class="bi bi-funnel me-2"></i>فیلتر وظایف</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="بستن"></button>
                </div>
    
                <!-- Modal Body -->
                <div class="modal-body p-5">
                  <form method="get" 
      action="{% url 'reports:students_reports' %}" 
      class="needs-validation tablelist-form" 
      id="studentReportForm" 
      novalidate="novalidate">

  <div class="row g-3 align-items-center">
    <div class="col-md-6">
      <label class="form-label fw-semibold">تاریخ آغاز</label>
      <div class="input-group">
        <span class="input-group-text"><img src="{% static 'icon/uiw--date.svg' %}" alt=""></span>
        {{ form.start_date }}
      </div>
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">تاریخ پایان</label>
      <div class="input-group">
        <span class="input-group-text"><img src="{% static 'icon/uiw--date.svg' %}" alt=""></span>
        {{ form.end_date }}
      </div>
    </div>
  </div>

  <!-- Dropdown -->
  <div class="form-group mt-3">
    <label for="filterType" class="fw-semibold">نوع فلتر</label>
    <select class="form-control" id="filterType" name="filter_type" required>
      <option value="active_students">شاگردان فعال</option>
      <option value="deactive_students">شاگردان غیر فعال</option>
      <option value="loan_students">شاگردان قرضدار</option>
      <option value="students_withoutclass">شاگردان بدون صنف</option>
      <option value="students_complete_fess">شاگردان که فیس شان پوره شده</option>
    </select>
  </div>

  <!-- Bootstrap Alert -->
  <div class="alert alert-warning alert-dismissible fade d-none mt-3" id="feesAlert" role="alert">
    <strong>توجه!</strong> برای دیدن شاگردانی که فیس شان پوره شده، لطفاً تاریخ آغاز یا تاریخ پایان را انتخاب کنید.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <div class="d-flex justify-content-end mt-4 gap-2">
    <button type="submit" class="btn btn-success btn-lg fw-bold">
      <i class="bi bi-funnel-fill me-2"></i>اعمال فیلتر
    </button>
    <button type="button" class="btn btn-outline-secondary btn-lg" data-bs-dismiss="modal">
      <i class="bi bi-x-circle me-2"></i>لغو
    </button>
  </div>
</form>

<!-- JS -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const filterType = document.getElementById('filterType');
  const alertBox = document.getElementById('feesAlert');

  // Listen to dropdown changes
  filterType.addEventListener('change', function () {
    const startDate = document.querySelector('[name="start_date"]').value.trim();
    const endDate = document.querySelector('[name="end_date"]').value.trim();

    // Hide first
    alertBox.classList.add('d-none');

    // Show if condition matches
    if (this.value === 'students_complete_fess' && (!startDate || !endDate)) {
      alertBox.classList.remove('d-none');
      // Use Bootstrap's fade-in animation
      setTimeout(() => alertBox.classList.add('show'), 10);
    }
  });

  // Handle close button properly
  alertBox.addEventListener('closed.bs.alert', function () {
    alertBox.classList.add('d-none');
  });
});
</script>

                </div>
            </div>
        </div>
    </div>

    
</div>


<style>
    /* Apply styles for all screen sizes */
    #pwa-install-btn {
        position: relative;
        border-radius: 50px;
        background: radial-gradient(circle at center, #ff6a00, #ff0080);
        /* Starting blend */
        color: #fff;
        font-size: 15px;
        font-weight: 600;
        padding: 10px 25px;
        margin-top: 10px;
        font-family: XW_Zar_Bd_0;
        z-index: 1;
        overflow: hidden;
        animation: centerColorBlend 6s ease-in-out infinite;
        background-size: 200% 200%;
        border: none;
    }

    /* Animated multicolor border */
    #pwa-install-btn:after {
        content: '';
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        border-radius: 50px;
        background: linear-gradient(60deg, #f79533, #f37055, #ef4e7b, #a166ab, #5073b8, #1098ad, #07b39b, #6fba82);
        z-index: -1;
        animation: animatedborder 3s linear infinite;
        background-size: 300% 300%;
    }

    /* Border animation */
    @keyframes animatedborder {
        0% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }

        100% {
            background-position: 0% 50%;
        }
    }

    /* Center gradient animation */
    @keyframes centerColorBlend {
        0% {
            background: radial-gradient(circle at center, #ff6a00, #ff0080);
        }

        33% {
            background: radial-gradient(circle at center, #ff0080, #00c3ff);
        }

        66% {
            background: radial-gradient(circle at center, #00c3ff, #00ff72);
        }

        100% {
            background: radial-gradient(circle at center, #ff6a00, #ff0080);
        }
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        $('#datepicker20').datepicker({});
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        $('#datepicker21').datepicker({});
    });
</script>
{% endblock %}