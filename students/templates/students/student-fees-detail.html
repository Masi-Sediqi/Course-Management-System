{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="main-content pt-4" style="font-family: XW_Zar_Bd_0;">
    <div class="breadcrumb">
        <h1>بخش جمع آوری فیس شاگردان</h1>
        <ul>
            <li><a href="" onclick="window.history.back();">برگشت</a></li>
            <li>داشبورد</li>
        </ul>
    </div>
    <div class="separator-breadcrumb border-top"></div>
    <!-- content goes here-->
    <section class="ul-todo-list-content">

      
        <div class="ul-todo-content-right">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-transparent">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="ul-todo-mobile-menu mr-3 p-2"><i class="nav-icon i-Align-Justify-All text-25 ul-contact-mobile-icon"></i></div>
                                <div class="btn-group">
                                  <a href="javascript:history.back()" class="btn btn-info mr-2">
                                    بازگشت
                                </a>
                                
                                  <button class="btn btn-outline-success mr-2" type="button" data-toggle="modal" data-target=".bd-example-modal-lg">
                                      فیس جدید
                                  </button>
                              
                                  <button class="btn btn-outline-success" type="button" data-toggle="modal" data-target="#giveFeesModal">
                                      جبران قرض داری
                                  </button>
                              </div>                              
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="ul-todo-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item p-0">
                                        <div class="table-responsive">
                                          <table class="table table-bordered table-hover table-striped mb-0">
                                            <thead class="table-light">
                                                <tr class="text-center">
                                                    <th>تاریخ</th>
                                                    <th>ماه</th>
                                                    <th>فیس اصلی</th>
                                                    <th>فیس داده شده</th>
                                                    <th>باقی مانده</th>
                                                    <th>توضیحات</th>
                                                    <th>عملیات</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for i in fees_record_related_student %}
                                                <tr class="text-center">
                                                    <td>{{ i.date }}</td>
                                                    <td>{{ i.month }}</td>
                                                    <td>{{ i.orginal_fees }}</td>
                                                    <td>{{ i.give_fees }}</td>
                                                    <td>{{ i.remain_fees }}</td>
                                                    <td>{{ i.description }}</td>
                                                    <td class="text-center position-relative">
                                                      <div class="dropdown">
                                                          <button class="btn bg-gray _r_btn border-0" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                              <span class="_dot _inline-dot bg-primary"></span>
                                                              <span class="_dot _inline-dot bg-primary"></span>
                                                              <span class="_dot _inline-dot bg-primary"></span>
                                                          </button>
                                                          <div class="dropdown-menu dropdown-menu-left">
                                                              <a class="dropdown-item text-success" href="#">
                                                                  <i class="nav-icon i-Pen-2 mr-2"></i> ویرایش
                                                              </a>
                                                              <a class="dropdown-item text-danger" href="#">
                                                                  <i class="nav-icon i-Close-Window mr-2"></i> حذف
                                                              </a>
                                                              <a class="dropdown-item text-primary" href="{% url 'students:student_bill' fees_id=i.id student_id=i.student.id %}">
                                                                  <i class="nav-icon i-File-PDF mr-2"></i> چاپ بل
                                                              </a>
                                                          </div>
                                                      </div>
                                                  </td>
                                                  
                                                </tr>
                                                {% endfor %}
                                        
                                                <!-- Total Remaining Row -->
                                                <tr class="text-center font-weight-bold text-danger">
                                                    <td colspan="3">مجموع باقیات فیس</td>
                                                    <td>{{ get_remain_money.amount|default:"0" }}</td>
                                                    <td colspan="2"> </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                       
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>                        
                    </div>
                </div>
            </div>
        </div>
    </section><!-- end of main-content -->
    <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <form method="POST" action="{% url 'students:student_fees_detail' student_id=student.id %}">
          {% csrf_token %}
          <div class="modal-dialog modal-lg">
            <div class="modal-content p-3">
              <div class="card-title h5 mb-3">اضافه کردن فیس</div>
              <div>
                <div class="row">
                  <div class="col-md-4 form-group mb-3">
                    <label for="{{ form.date.id_for_label }}">تاریخ</label>
                    {{ form.date }}
                  </div>
                  <div class="col-md-4 form-group mb-3">
                    <label for="{{ form.orginal_fees.id_for_label }}">فیس اصلی</label>
                    {{ form.orginal_fees }}
                  </div>
                  <div class="col-md-4 form-group mb-3 position-relative">
                    <label for="{{ form.give_fees.id_for_label }}">مقدار فیس داده شده <span class="text-danger">*</span></label>
                    {{ form.give_fees }}
                    <div id="warning-msg" class="text-danger mt-1" style="display: none;">
                      مقدار فیس داده شده نباید بزرگتر از مقدار اصلی فیس باشد!
                    </div>
                    <div id="overlay" style="
                      display: none;
                      position: absolute;
                      top: 38px; /* adjust this if needed */
                      left: 0;
                      right: 0;
                      height: 38px;
                      background: rgba(255, 255, 255, 0.6);
                      z-index: 10;
                      pointer-events: none;
                      border-radius: 4px;
                    "></div>
                  </div>
                </div>
      
                <div class="col-md-12 form-group mb-3">
                  <label for="{{ form.description.id_for_label }}">توضیحات</label>
                  {{ form.description }}
                </div>
      
                <div class="text-end">
                  <input type="hidden" name="form_type" value="givefees">
                  <button class="btn btn-primary mt-2" type="submit">ذخیره کردن</button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const orginalFeesInput = document.getElementById('id_orginal_fees');
          const giveFeesInput = document.getElementById('id_give_fees');
          const warningMsg = document.getElementById('warning-msg');
          const overlay = document.getElementById('overlay');
      
          function validateFees() {
            const orginalValue = parseFloat(orginalFeesInput.value);
            const giveValue = parseFloat(giveFeesInput.value);
      
            if (!isNaN(orginalValue) && !isNaN(giveValue)) {
              if (giveValue > orginalValue) {
                warningMsg.style.display = 'block';
                overlay.style.display = 'block';
                giveFeesInput.style.borderColor = 'red';
              } else {
                warningMsg.style.display = 'none';
                overlay.style.display = 'none';
                giveFeesInput.style.borderColor = '';
              }
            } else {
              warningMsg.style.display = 'none';
              overlay.style.display = 'none';
              giveFeesInput.style.borderColor = '';
            }
          }
      
          orginalFeesInput.addEventListener('input', validateFees);
          giveFeesInput.addEventListener('input', validateFees);
        });
      </script>
      
      <div class="modal fade" id="giveFeesModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <form method="POST" action="{% url 'students:student_fees_detail' student_id=student.id %}">
          {% csrf_token %}
          <div class="modal-dialog modal-lg">
            <div class="modal-content p-3">
              <div class="card-title h5 mb-3">بخش جبران قرض داری های شاگرد {{ student.first_name }}</div>
              <div>
                <div class="row">
                  <div class="col-md-4 form-group mb-3">
                    <label for="">تاریخ</label>
                    {{ g_form.date }}
                  </div>
                  <div class="col-md-4 form-group mb-3">
                    <label for="">مقدار باقی مانده</label>
                    <input id="remainAmount" class="form-control" type="number" value="{{ get_remain_money.amount }}" readonly>
                  </div>
                  <div class="col-md-4 form-group mb-3">
                    <label for="{{ g_form.amount.id_for_label }}">مقدار</label>
                    {{ g_form.amount }}
                    <div id="amount-error" class="text-danger mt-1" style="display:none;">شما نمی‌توانید مقداری بزرگ‌تر از مقدار باقی‌مانده وارد کنید!</div>
                  </div>
                </div>
                
                <script>
                  // Get elements
                  const remainInput = document.getElementById('remainAmount');
                  const amountInput = document.getElementById('{{ g_form.amount.id_for_label }}');
                  const errorDiv = document.getElementById('amount-error');
                
                  // Validate on input change
                  amountInput.addEventListener('input', () => {
                    const remainValue = parseFloat(remainInput.value) || 0;
                    const amountValue = parseFloat(amountInput.value) || 0;
                
                    if (amountValue > remainValue) {
                      errorDiv.style.display = 'block';
                      amountInput.setCustomValidity("Invalid field.");
                    } else {
                      errorDiv.style.display = 'none';
                      amountInput.setCustomValidity("");
                    }
                  });
                </script>                
      
                <div class="col-md-12 form-group mb-3">
                  <label for="{{ form.description.id_for_label }}">توضیحات</label>
                  {{ g_form.description }}
                </div>

                <script>
                  document.addEventListener('DOMContentLoaded', function () {
                      $('#datepicker21').datepicker({});
                  });
              </script>
      
                <div class="text-end">
                  <button class="btn btn-primary mt-2" type="submit">ذخیره کردن</button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
</div>
  


<script>
    document.addEventListener('DOMContentLoaded', function () {
        $('#datepicker3').datepicker({});
    });
</script>






{% endblock %}
