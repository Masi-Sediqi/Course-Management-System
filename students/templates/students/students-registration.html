{% extends 'base.html'%}
{% load static %}
{% block content %}

<div class="container-xxl flex-grow-1 container-p-y" style="font-family: 'Vazirmatn', sans-serif;">

  <h4 class="py-3 mb-4">
    <span class="text-muted fw-light">داشبورد / </span>ثبت شاگردان جدید
  </h4>

  <link href="{% static 'css/sweet.css' %}" rel="stylesheet">
  <script src="{% static 'js/sweet.js' %}"></script>

  <script>
    {% if messages %}
    {% for message in messages %}
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}",
      title: "{{ message|escapejs }}",
      showConfirmButton: false,
      timer: 4000,
      timerProgressBar: true,
      didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer)
        toast.addEventListener('mouseleave', Swal.resumeTimer)
      }
    });
    {% endfor %}
    {% endif %}
  </script>

  <!-- Action Buttons -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between">
        <button class="btn btn-info" type="button" data-toggle="modal" data-target="#exampleModal">
          <i class="fas fa-user-plus ml-2"></i>شاگرد جدید
        </button>
        <a href="{% url 'home:dashboard' %}" class="btn btn-secondary">
          <i class="fas fa-arrow-right ml-2"></i>بازگشت
        </a>
      </div>
    </div>
  </div>

  <!-- Students Table Card -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title mb-4">لیست شاگردان</h5>
      
      <!-- Search Box -->
      <div class="mb-3">
        <div class="input-group">
          <div class="input-group-prepend">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
          </div>
          <input type="text" id="studentSearch" class="form-control" placeholder="جستجو در بین شاگردان...">
        </div>
      </div>

      <!-- Table -->
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="thead-light">
            <tr>
              <th scope="col" width="50">#</th>
              <th scope="col">عکس</th>
              <th scope="col">نام کامل</th>
              <th scope="col">نام پدر</th>
              <th scope="col">شماره تماس</th>
              <th scope="col">جنسیت</th>
              <th scope="col" width="120" class="text-center">عملیات</th>
            </tr>
          </thead>
          <tbody>
            {% for student in students %}
            <tr>
              <th scope="row">{{ forloop.counter }}</th>
              
              <!-- Avatar/Image -->
              <td>
                {% if student.image %}
                <img src="{{ student.image.url }}" 
                     alt="{{ student.first_name }}"
                     class="rounded-circle avatar-img"
                     width="40" height="40">
                {% else %}
                <div class="avatar-placeholder rounded-circle d-flex align-items-center justify-content-center"
                     style="width: 40px; height: 40px; background-color: #4e73df; color: white; font-weight: bold;">
                  {{ student.first_name|first }}
                </div>
                {% endif %}
              </td>
              
              <!-- Full Name -->
              <td>
                <a href="{% url 'students:student_detail' student.id %}" class="text-primary">
                  {{ student.first_name }} {{ student.last_name|default:"" }}
                </a>
              </td>
              
              <!-- Father Name -->
              <td>{{ student.father_name|default:"-" }}</td>
              
              <!-- Phone -->
              <td>{{ student.phone|default:"-" }}</td>
              
              <!-- Gender -->
              <td>
                {% if student.gender == 'Male' %}
                <span class="badge badge-primary">مرد</span>
                {% else %}
                <span class="badge badge-pink">زن</span>
                {% endif %}
              </td>
              
              <!-- Actions -->
              <td class="text-center">
                <div class="dropdown">
                  <button class="btn btn-sm btn-light dropdown-toggle" type="button" 
                          id="dropdownMenuButton{{ student.id }}" data-toggle="dropdown" 
                          aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu dropdown-menu-right" 
                       aria-labelledby="dropdownMenuButton{{ student.id }}">
                    <a class="dropdown-item" href="{% url 'students:student_detail' student.id %}">
                      <i class="fas fa-eye ml-2 text-info"></i>مشاهده
                    </a>
                    <a class="dropdown-item" href="{% url 'students:edit_students' student.id %}">
                      <i class="fas fa-edit ml-2 text-warning"></i>ویرایش
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item text-danger" data-toggle="modal"
                       data-target="#deleteConfirmModal{{ student.id }}">
                      <i class="fas fa-trash ml-2"></i>حذف
                    </a>
                  </div>
                </div>
              </td>
            </tr>

            <!-- Delete Confirmation Modal -->
            <div class="modal fade" id="deleteConfirmModal{{ student.id }}" tabindex="-1" role="dialog">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">تأیید حذف</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="بستن">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <p>آیا مطمئن هستید که می‌خواهید <strong>{{ student.first_name }}</strong> را حذف کنید؟</p>
                    <p class="text-muted small">این عملیات قابل بازگشت نیست.</p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">انصراف</button>
                    <a href="{% url 'students:delete_students' student.id %}" class="btn btn-danger">
                      حذف
                    </a>
                  </div>
                </div>
              </div>
            </div>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center py-5">
                <div class="empty-state">
                  <i class="fas fa-users fa-3x text-muted mb-3"></i>
                  <h6 class="text-muted">هیچ شاگردی یافت نشد</h6>
                  <p class="text-muted small">برای افزودن شاگرد جدید روی دکمه "شاگرد جدید" کلیک کنید</p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">ثبت نام شاگردان</h5>
        </div>
        <div class="modal-body">
          <form class="row g-3 needs-validation" novalidate method="post"
            action="{% url 'students:students_registration' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="col-12">
              <h5>معلومات شاگرد</h5>
            </div>

            <!-- First Name -->
            <div class="col-md-12 d-flex align-items-center">
              <label for="firstName1" class="col-sm-4 col-form-label">نام مکمل<span class="text-danger">*</span></label>
              <div class="col-sm-8">
                {{ form.first_name }}
              </div>
            </div>

            <!-- Father Name -->
            <div class="col-md-12 d-flex align-items-center">
              <label for="fatherName" class="col-sm-4 col-form-label">نام پدر</label>
              <div class="col-sm-8">
                {{ form.father_name }}
              </div>
            </div>

            <!-- Phone -->
            <div class="col-md-12 d-flex align-items-center">
              <label for="phone" class="col-sm-4 col-form-label">شماره تماس</label>
              <div class="col-sm-8">
                {{ form.phone }}
              </div>
            </div>

            <!-- Gender -->
            <div class="col-md-12 d-flex align-items-center">
              <label for="gender" class="col-sm-4 col-form-label">جنسیت<span class="text-danger">*</span></label>
              <div class="col-sm-8">
                {{ form.gender }}
              </div>
            </div>

            <!-- Image -->
            <div class="col-md-12 d-flex align-items-center">
              <label for="image" class="col-sm-4 col-form-label">عکس</label>
              <div class="col-sm-8">
                {{ form.image }}
              </div>
            </div>
            <!-- Submit Buttons -->
            <div class="col-12 d-flex justify-content-end mt-3">
              <button class="btn btn-primary" type="submit">ذخیره کردن</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

</div>



<style>
  .avatar-img {
    object-fit: cover;
    border: 2px solid #e3e6f0;
  }
  
  .avatar-placeholder {
    font-size: 18px;
  }
  
  .badge-pink {
    background-color: #e83e8c;
    color: white;
  }
  
  .dropdown-menu {
    min-width: 150px;
    border-radius: 8px;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
  }
  
  .dropdown-item {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
  }
  
  .dropdown-item i {
    width: 20px;
  }
  
  .empty-state {
    padding: 3rem 1rem;
  }
  
  .table th {
    font-weight: 600;
    border-top: none;
    color: #4e73df;
  }
  
  .table td {
    vertical-align: middle;
  }
  
  .table-hover tbody tr:hover {
    background-color: rgba(78, 115, 223, 0.05);
  }
</style>

<script>
  // Search functionality
  document.getElementById('studentSearch').addEventListener('keyup', function() {
    const searchValue = this.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
      const rowText = row.textContent.toLowerCase();
      row.style.display = rowText.includes(searchValue) ? '' : 'none';
    });
  });
</script>

{% endblock %}